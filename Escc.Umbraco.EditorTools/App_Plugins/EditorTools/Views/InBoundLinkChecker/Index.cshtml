@{
    Layout = "~/App_Plugins/EditorTools/Views/Shared/_Layout.cshtml";
}

@model Escc.Umbraco.EditorTools.App_Plugins.EditorTools.Models.ViewModels.InBoundLinkCheckerViewModel

<div id="InboundLinkChecker">

    <p> </p>
    <div class="panel panel-info">
        <div class="panel-heading">Link Checker</div>
        <div class="panel-body">
            <p>This tool is an experimental work in progress. I am still working out the bugs and fine tuning the crawling process.</p>
            <p>At the moment it will only crawl the published umbraco pages and look for any links found on those published pages.</p>
        </div>
    </div>

    <div class="list-group panel panel-info">
        <a href="#InboundLinkCheckerPanel" class="list-group-item" data-toggle="active" data-parent="#InboundLinkChecker"><span class="glyphicon glyphicon-repeat"></span> <b>InBound Link Checker</b></a>
        <div class="active" id="InboundLinkCheckerPanel">
            <div class="thumbnail">
                <p>  </p>
                <div class="panel with-nav-tabs panel-czone">
                    <div class="panel-heading">
                        <ul class="nav nav-tabs">
                            @if (Model.CachedDataAvailable)
                            {
                                <li class="active"><a href="#InboundLinks" data-toggle="tab"><b>Search</b></a></li>
                                <li><a href="#VerifiedLinks" data-toggle="tab"><b>Verified Links</b></a></li>
                                <li><a href="#BrokenPageLinks" data-toggle="tab"><b>Broken Links</b></a></li>
                                <li><a href="#LinksFound" data-toggle="tab"><b>Links Found</b></a></li>
                                <li><a href="#Crawl" data-toggle="tab"><b>Crawler</b></a></li>
                            }
                            else
                            {
                                <li class="active"><a href="#Crawl" data-toggle="tab"><b>Crawler</b></a></li>
                            }
                        </ul>
                    </div>
                    <div class="panel-body">
                        <div class="tab-content">
                            @if (Model.CachedDataAvailable)
                            {
                                <div class="tab-pane fade in active" id="InboundLinks">
                                    <div class="panel panel-info">
                                        <div class="panel-heading"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></div>
                                        <div class="panel-body">
                                            <div class="row">
                                                @using (Html.BeginForm("SearchForInBoundLinks", "InBoundLinkChecker", FormMethod.Post))
                                                {
                                                    @Html.HiddenFor(x => x.CachedDataAvailable)
                                                    @Html.HiddenFor(x => x.DataBeingGenerated)
                                                    <div class="form-group">
                                                        <div class="col-md-4 col-md-offset-1">
                                                            @Html.TextBoxFor(m => m.Query, new { @placeholder = "Search", @class = "form-control" })
                                                        </div>

                                                        <div class="col-md-1">
                                                            <input type="submit" class="btn btn-primary" value="Search" />
                                                        </div>

                                                        <div class="col-md-3">
                                                            <p>Pages Indexed: @Model.IndexedPagesTotal</p>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                            <p></p>
                                            @if (Model.HasInBoundLinks)
                                            {
                                                <div class="panel panel-success">
                                                    <div class="panel-heading">Pages found that contain the link: @Model.Query</div>
                                                    <div class="panel-body">
                                                        <div class="row">
                                                            @{Html.RenderPartial("~/App_Plugins/EditorTools/Views/Partials/_DataTable.cshtml", Model.InBoundLinks);}
                                                        </div>
                                                    </div>
                                                </div>

                                                                }
                                            @if (!Model.HasInBoundLinks && Model.Query != null)
                                            {
                                                <div class="panel panel-danger">
                                                    <div class="panel-heading">InBound Links</div>
                                                    <div class="panel-body">
                                                        <div class="row">
                                                            <p> No Results found for : @Model.Query</p>
                                                        </div>
                                                    </div>
                                                </div>

                                            }

                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="VerifiedLinks">
                                    <div class="panel panel-success">
                                        <div class="panel-heading"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"> Verified Links</span></div>
                                        <div class="panel-body">
                                            @{Html.RenderPartial("~/App_Plugins/EditorTools/Views/Partials/_DataTable.cshtml", Model.IndexedLinks);}
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="BrokenPageLinks">
                                    <div class="panel panel-danger">
                                        <div class="panel-heading"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"> Broken Links</span></div>
                                        <div class="panel-body">
                                            @{Html.RenderPartial("~/App_Plugins/EditorTools/Views/Partials/_DataTable.cshtml", Model.BrokenLinks);}
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="LinksFound">
                                    <div class="panel panel-info">
                                        <div class="panel-heading"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"> Unique Links Found On Pages</span></div>
                                        <div class="panel-body">
                                            @{Html.RenderPartial("~/App_Plugins/EditorTools/Views/Partials/_DataTable.cshtml", Model.LinksFoundTable);}
                                        </div>
                                    </div>
                                </div>
                                                }
                            @if (Model.CachedDataAvailable)
                            {
                                <div class="tab-pane fade" id="Crawl">
                                    <div class="panel panel-info">
                                        <div class="panel-heading"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></div>
                                        <div class="panel-body">
                                            @{
                                                if (Model.ExternalDataBeingGenerated)
                                                {
                                                    <p></p>
                                                    <div class="panel panel-success">
                                                        <div class="panel-heading">Crawling External Links...</div>
                                                        <div class="panel-body">
                                                            <p>External Link data is being generated, this may take some time...</p>
                                                            <p>Pages Crawled: @Model.CrawledExternalLinks / @Model.TotalExternalToCrawl</p>

                                                            @{
                                                                var complete = "0%";
                                                                // prevent a divide by 0
                                                                if (Model.CrawledExternalLinks > 0)
                                                                {
                                                                    int percentageComplete = (int)((double)Model.CrawledExternalLinks / (double)Model.TotalExternalToCrawl * 100);
                                                                    complete = string.Format("{0}%", percentageComplete);
                                                                }
                                                            }

                                                            <div class="progress progress-striped active" id="ProgressBar">
                                                                <div class="progress-bar " role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:@complete">
                                                                    <span class="sr-only">100% Complete</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <div class="panel panel-success">
                                                                        <div class="panel-heading">Internal Crawl</div>
                                                                        <div class="panel-body">
                                                                            <p>Data has been cached for your internal umbraco site. You can choose to crawl again below.</p>
                                                                            <div class="row">
                                                                                @using (Html.BeginForm("StartCrawl", "InBoundLinkChecker", FormMethod.Post))
                                                                                {
                                                                                    <div class="form-group">
                                                                                        <div class="col-md-6 col-md-offset-2">
                                                                                            @Html.TextBoxFor(m => m.SiteUri, new { @placeholder = "e.g. https://www.eastsussex.gov.uk", @class = "form-control" })
                                                                                        </div>

                                                                                        <div class="col-md-2">
                                                                                            <input type="submit" class="btn btn-primary" value="Crawl" />
                                                                                        </div>
                                                                                    </div>
                                                                                }
                                                                            </div>

                                                                        </div>
                                                                    </div>
                                                                    <div class="panel panel-success">
                                                                        <div class="panel-heading">External Crawl</div>
                                                                        <div class="panel-body">
                                                                            <p>Now that your published pages have been crawled, you can choose to go a level deeper here.</p>
                                                                            <p>This external crawl will go through and verify the links found on each published page, and then index the links found on those pages. You can repeat this process as many times as you like to go as deep as you wish.</p>
                                                                            <p>While each time you run this process it will ignore links it has already verified, theoretically if you go too deep, it could take an extreme amount of time to finish. ( I recommend only going 1 level deep )</p>
                                                                            <p>As an example the 2500 pages i tested this on had roughly 16'000 unique links. Taking in to account that those unique links probably include the 2500 published pages, that means there are at least 13'500 links to check on the first external level. This figure will increase exponentially each time you run this crawl.</p>
                                                                            <div class="row">
                                                                                @using (Html.BeginForm("StartExternalCrawl", "InBoundLinkChecker", FormMethod.Post))
                                                                                {
                                                                                    @Html.HiddenFor(x => x.CachedDataAvailable)
                                                                                    @Html.HiddenFor(x => x.DataBeingGenerated)
                                                                                    <div class="form-group">
                                                                                        <div class="col-md-2">
                                                                                            <input type="submit" class="btn btn-primary" value="Crawl" />
                                                                                        </div>
                                                                                    </div>
                                                                                }
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="panel panel-success">
                                                                        <div class="panel-heading">Domains Found</div>
                                                                        <div class="panel-body">
                                                                            @{Html.RenderPartial("~/App_Plugins/EditorTools/Views/Partials/_DataTable.cshtml", Model.Domains);}
                                                                        </div>
                                                                    </div>

                                                                                }

                                            }
                                        </div>
                                    </div>
                                </div>
                                                                                }
                                                                                else
                                                                                {

                                                                                    <div class="tab-pane fade in active" id="Crawl">
                                                                                        <div class="panel panel-info">
                                                                                            <div class="panel-heading"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></div>
                                                                                            <div class="panel-body">
                                                                                                @{ if (Model.DataBeingGenerated)
                                                                                                    {
                                                                                                        <p></p>
                                                                                                        <div class="panel panel-success">
                                                                                                            <div class="panel-heading">Crawling...</div>
                                                                                                            <div class="panel-body">
                                                                                                                <p>Data is still being generated, come back in a few minutes or the page will periodically refresh every 5 seconds. For especially large sites this process can take at least 10 minutes to crawl and index all published pages.</p>
                                                                                                                <p>Pages Crawled: @Model.CrawledLinks / @Model.TotalToCrawl</p>

                                                                                                                @{
                                                                                                                    var complete = "0%";
                                                                                                                    // prevent a divide by 0
                                                                                                                    if (Model.CrawledLinks > 0)
                                                                                                                    {
                                                                                                                        int percentageComplete = (int)((double)Model.CrawledLinks / (double)Model.TotalToCrawl * 100);
                                                                                                                        complete = string.Format("{0}%", percentageComplete);
                                                                                                                    }
                                                                                                                }

                                                                                                                <div class="progress progress-striped active" id="ProgressBar">
                                                                                                                    <div class="progress-bar " role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:@complete">
                                                                                                                        <span class="sr-only">100% Complete</span>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                                    }
                                                                                                }

                                                                                                @{ if (!Model.CachedDataAvailable && !Model.DataBeingGenerated)
                                                                                                    {
                                                                                                        <p></p>
                                                                                                        <div class="panel panel-warning">
                                                                                                            <div class="panel-heading">No Data</div>
                                                                                                            <div class="panel-body">
                                                                                                                <p>There is no cached data available to search. enter the uri for your umbraco site and click 'Crawl' to get started.</p>
                                                                                                                <div class="row">
                                                                                                                    @using (Html.BeginForm("StartCrawl", "InBoundLinkChecker", FormMethod.Post))
                                                                                                                    {
                                                                                                                        <div class="form-group">
                                                                                                                            <div class="col-md-6 col-md-offset-2">
                                                                                                                                @Html.TextBoxFor(m => m.SiteUri, new { @placeholder = "e.g. https://www.eastsussex.gov.uk", @class = "form-control" })
                                                                                                                            </div>

                                                                                                                            <div class="col-md-2">
                                                                                                                                <input type="submit" class="btn btn-primary" value="Crawl" />
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                    }
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        </div>

                                                                                                    }
                                                                                                }
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                                    }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
