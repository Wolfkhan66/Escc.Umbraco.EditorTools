@{
    Layout = "~/App_Plugins/EditorTools/Views/Shared/_Layout.cshtml";
}
@{
    ViewBag.Title = "InBoundLinkChecker";
}

@model Escc.Umbraco.EditorTools.App_Plugins.EditorTools.Models.ViewModels.InBoundLinkCheckerViewModel

<p> </p>
<div class="panel panel-info">
    <div class="panel-heading">InBound Links</div>
    <div class="panel-body">
        <div class="row">
            <p>This tool is an experimental work in progress. I am still working out the bugs and fine tuning the index process.</p>
            <p>It should give results if you search for a page, but it might not be totally correct yet.</p>
        </div>
    </div>
</div>

@{ if (Model.CachedDataAvailable)
    {
        <p></p>
        <div class="panel panel-info">
            <div class="panel-heading">InBound Links</div>
            <div class="panel-body">
                <div class="row">
                    @using (Html.BeginForm("SearchForInBoundLinks", "InBoundLinkChecker", FormMethod.Post))
                    {
                        @Html.HiddenFor(x => x.CachedDataAvailable)
                        @Html.HiddenFor(x => x.DataBeingGenerated)
                        @Html.HiddenFor(x => x.FailedLinks)

                        <div class="form-group">
                            <div class="col-md-4 col-md-offset-1">
                                @Html.TextBoxFor(m => m.Query, new {@placeholder = "Search", @class = "form-control" } )
                            </div>

                            <div class="col-md-1">
                                <input type="submit" class="btn btn-primary" value="Search" />
                            </div>

                            <div class="col-md-1">
                                <p>Pages Indexed: @Model.IndexedPagesTotal</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        foreach (var item in Model.FailedLinks)
        {
            <p>@item.Value</p>
        }

        if (Model.HasInBoundLinks)
        {
            <div class="panel panel-success">
                <div class="panel-heading">Links found for: @Model.Query</div>
                <div class="panel-body">
                    <div class="row">
                        @{Html.RenderPartial("~/App_Plugins/EditorTools/Views/Partials/_DataTable.cshtml", Model.InBoundLinks);}
                    </div>
                </div>
            </div>

                            }
                            if (!Model.HasInBoundLinks && Model.Query != null)
                            {
                                <div class="panel panel-danger">
                                    <div class="panel-heading">InBound Links</div>
                                    <div class="panel-body">
                                        <div class="row">
                                            <p> No Results found for : @Model.Query</p>
                                        </div>
                                    </div>
                                </div>

                                }

                            }
}

@{ if (Model.DataBeingGenerated)
    {
        <p></p>
        <meta http-equiv="refresh" content="10"/>
        <div class="panel panel-info">
            <div class="panel-heading">Crawling...</div>
            <div class="panel-body">
                <p>Data is still being generated, come back in a few minutes or the page will continue to refresh every 10 seconds. For especially large sites this process can take at least 10 minutes to crawl and index all published umbraco pages.</p>
                <p>Pages Crawled: @Model.CrawledLinks / @Model.TotalToCrawl</p>

                @{
                    var complete = "0%";
                    // prevent a divide by 0
                    if (Model.CrawledLinks > 0)
                    {
                        int percentageComplete = (int)((double)Model.CrawledLinks / (double)Model.TotalToCrawl * 100);
                        complete = string.Format("{0}%", percentageComplete);
                    }
                }

                <div class="progress progress-striped active" id="ProgressBar">
                    <div class="progress-bar " role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:@complete">
                        <span class="sr-only">100% Complete</span>
                    </div>
                </div>
            </div>
        </div>
    }
}

@{ if (!Model.CachedDataAvailable && !Model.DataBeingGenerated)
    {
        <p></p>
        <div class="panel panel-info">
            <div class="panel-heading">No Data</div>
            <div class="panel-body">
                <p>There is no cached data available to search. enter the uri for your umbraco site and click 'Crawl' to get started.</p>
                <div class="row">
                    @using (Html.BeginForm("StartCrawl", "InBoundLinkChecker", FormMethod.Post))
                    {
                        <div class="form-group">
                            <div class="col-md-6 col-md-offset-2">
                                @Html.TextBoxFor(m => m.SiteUri, new { @placeholder = "e.g. https://www.eastsussex.gov.uk", @class = "form-control" })
                            </div>

                            <div class="col-md-2">
                                <input type="submit" class="btn btn-primary" value="Crawl" />
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
}