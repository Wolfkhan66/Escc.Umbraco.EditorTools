<!DOCTYPE html>
<head>
    <title>Content App</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="../../Content/DataTables/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <script src="../../scripts/DataTables/jquery.dataTables.js"></script>
    <script src="../../scripts/DataTables/dataTables.bootstrap.js"></script>
    <script src="../../Umbraco/lib/bootstrap/js/bootstrap.2.3.2.js"></script>
</head>

<body>
    <div class="container">

        <ul class="umb-load-indicator animated -half-second" id="loadindicator">
            <li class="umb-load-indicator__bubble"></li>
            <li class="umb-load-indicator__bubble"></li>
            <li class="umb-load-indicator__bubble"></li>
        </ul>

        <div class="jumbotron" id="pageJumbotron" style="background-color:#f0f78a">
            <div class="container">
                <h1>Media Search</h1>
                <p>The table can take some time to generate the first time it is run, please be patient.</p>
            </div>
        </div>

        <div class="jumbotron" id="pageLoadedJumbotron" style="background-color:#97d9ed">
            <div class="container">
                <h1>Media Search</h1>
                <p id="reportDate">Generated at: </p>
                <button class="btn btn-primary btn-lg" type="button" id="Regenerate">Regenerate Report</button>
            </div>
        </div>


        <div class="col-md-4 col-md-offset-11">
            <button type="button" class="btn btn-info" id="refreshButton">Refresh</button>
            <p>   </p>
        </div>

        <div class="row">
            <table class="table table-striped table-bordered" cellspacing="0" width="100%" id="contentTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Media Type</th>
                        <th>Date Created</th>
                        <th>Created By</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>Name</th>
                        <th>Media Type</th>
                        <th>Date Created</th>
                        <th>Created By</th>
                    </tr>
                </tfoot>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // hide elements until the script has completed
        $('#contentTable').hide();
        $('#refreshButton').hide();
        $('#loadindicator').hide();
        $('#pageLoadedJumbotron').hide();

        // run this function as the page is loaded
        GenerateReport('/GetAllMedia');

        // if the regenerate button is clicked, hide the page loaded jumbotron, show the default page jumbotron and run the function generateReport
        $('#Regenerate').on('click', function (event) {
            $('#pageLoadedJumbotron').hide();
            $('#pageJumbotron').show();
            GenerateReport('/GetMediaRefresh');
        });

        function GenerateReport(uriFunction) {
            // the uri points to the controller for this page
            var uri = '/umbraco/backoffice/api/MediaSearch';
            // while the function is running  hide the table and buttons and show the load indicator
            $('#contentTable').hide();
            $('#buttons').hide();
            $('#loadindicator').show();

            $(document).ready(function () {
                // Send an AJAX request
                // uri links to the method GetAllContent in the controller. passing the variables typeID and typeName
                $.getJSON(uri + uriFunction)
                  .done(function (data) {
                      // On success, 'data' contains a list of nodes.

                      // if the contentTable is already a datatable, then the datatable has been populated before
                      // In which case clear the datatable of data and destroy it, allowing a new one to be instantiated
                      if ($.fn.dataTable.isDataTable('#contentTable')) {
                          $('#contentTable').DataTable().clear();
                          $('#contentTable').DataTable().destroy();
                      }

                      // for each item in the list data
                      $.each(data, function (key, item) {
                          //Add row
                          $('#contentTable').append('<tr><td><a href="/umbraco#/media/media/edit/' + item.Id + '">' + item.Name + '</a></td><td>' + item.ContentType + '</td><td>' + item.CreateDate + '</td><td>' + item.CreatorName + '</td></tr>');
                      });

                      // after table has been populated, hide the load indicator, the page jumbotron and show the table, refresh button and the loaded page jumbotron
                      $('#loadindicator').hide();
                      $('#contentTable').show();
                      $('#refreshButton').show();
                      $('#pageJumbotron').hide();
                      $('#pageLoadedJumbotron').show();

                      // create search boxes for each column in the table at the footer
                      $(document).ready(function () {
                          $('#contentTable tfoot th').each(function () {
                              var title = $(this).text();
                              $(this).html('<input type="text" placeholder="Search ' + title + '" />');
                          });

                          // instantiate the table as a datatable, make its default pagelength at 100, allow an existing table to be retrieved
                          // and push the search boxes at the foot to the top of the table, below the header
                          var table = $('#contentTable').DataTable({
                              "pageLength": 100,
                              retrieve: true,
                              initComplete: function () {
                                  var r = $('#contentTable tfoot tr');
                                  r.find('th').each(function () {
                                      $(this).css('padding', 8);
                                  });
                                  $('#contentTable thead').append(r);
                                  $('#search_0').css('text-align', 'center');
                              },
                          });

                          // when the refresh button is clicked, clear the search parameters on the table and redraw the table.
                          $('#refreshButton').on('click', function (event) {
                              table
                                .search('')
                                .columns().search('')
                                .draw();
                          });

                          // Apply the search to the table
                          table.columns().every(function () {
                              var that = this;
                              $('input', this.footer()).on('keyup change', function () {
                                  if (that.search() !== this.value) {
                                      that
                                          .search(this.value)
                                          .draw();
                                  }
                              });
                          });
                      });

                      $.getJSON(uri + '/GetReportDate')
                      .done(function (data) {
                          ($('#reportDate').text('Generated: ' + data));
                      });
                  });
            });
        }
    </script>
</body>
</html>