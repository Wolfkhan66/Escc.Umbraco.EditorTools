<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Content App</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
     <link href="../../Content/DataTables/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <script src="../../scripts/DataTables/jquery.dataTables.js"></script>
    <script src="../../scripts/DataTables/dataTables.bootstrap.js"></script>
    <script src="../../Umbraco/lib/bootstrap/js/bootstrap.2.3.2.js"></script>  
</head>

 
<body>
    <div class="container">

        <ul class="umb-load-indicator animated -half-second" id="loadindicator">
            <li class="umb-load-indicator__bubble"></li>
            <li class="umb-load-indicator__bubble"></li>
            <li class="umb-load-indicator__bubble"></li>
        </ul>

        <h2 id="header">Document Type Count</h2>

        <div class="list-group" id="typeNodes" />

        <div class="row">
            <div class="col-md-4 col-md-offset-11">
                <button type="button" class="btn btn-info" id="refreshButton">Refresh</button>
                <p>   </p>
            </div>
        </div>

        <div class="row">
            <table class="table table-striped table-bordered" cellspacing="0" width="100%" id="contentTable">
                <thead>
                    <tr>
                        <th>Heading</th>
                        <th>Type</th>
                        <th>Url</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>Heading</th>
                        <th>Type</th>
                        <th>Url</th>
                    </tr>
                </tfoot>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // hide the Table, Header and Refresh button until the script has completed
        $('#contentTable').hide();
        $('#header').hide();
        $('#refreshButton').hide();
        
        // the uri points to the controller for this page
        var uri = '/umbraco/backoffice/api/DocumentTypeUsage';
        $(document).ready(function () {
            // Send an AJAX request
            // links to the function GetAllDocumentTypes in the controller
            $.getJSON(uri + '/GetAllDocumentTypes')
              .done(function (data) {
                  // On success, 'data' contains a list of nodes.
                  // sort the data into alphabetical order
                  data.sort(function (a, b) { return (a.Name > b.Name) ? 1 : ((b.Name > a.Name) ? -1 : 0); });
                  // for each item in the list data
                  $.each(data, function (key, item) {
                      // append the item to the list with the id #typeNodes
                      $('<a class="list-group-item" id="' + item.Id + '">' + formatDocumentTypes(item) + ' </a>')
                          .appendTo($('#typeNodes'))
                          .click(function () {
                              // if the item on the list is clicked, show the load indicator on the item
                              // and run the fucntion createTable()
                              $('#loadindicator').appendTo($('#' + item.Id));
                              $('#loadindicator').show();
                              createTable(item.Id, item.Name);
                      });
                  });
                  // show the header after list has been populated
                  $('#header').show();
              });
        });
        // quick function to format the text of the list items
        function formatDocumentTypes(item) {
            return item.Name + ' (' + item.Count + ')';
        }    
    </script>

    <script>
        function createTable(typeID, typeName) {
            $(document).ready(function () {
                // Send an AJAX request
                // uri links to the method GetAllContent in the controller. passing the variables typeID and typeName
                $.getJSON(uri + '/GetAllContent?typeID=' + typeID + '&typeName=' + typeName)
                  .done(function (data) {
                      // On success, 'data' contains a list of nodes.

                      // if the contentTable is already a datatable, then a search has been done before
                      // In which case clear the datatable of data and destroy it, allowing a new one to be instantiated
                      if ($.fn.dataTable.isDataTable('#contentTable')) {
                          $('#contentTable').DataTable().clear();
                          $('#contentTable').DataTable().destroy();
                      }

                      // for each item in the list data
                      $.each(data, function (key, item) {
                          //Add row
                          $('#contentTable').append('<tr><td>' + item.Name + '</td><td>' + item.DocumentTypeAlias + '</td><td><a href="/umbraco#/content/content/edit/' + item.Id + '">' + item.Url + '</a></td></tr>');
                      });

                      // after table has been populated, hide the load indicator and show the table and refresh button
                      $('#loadindicator').hide();
                      $('#contentTable').show();
                      $('#refreshButton').show();

                      // create search boxes for each column in the table at the footer
                      $(document).ready(function () {
                          $('#contentTable tfoot th').each(function () {
                              var title = $(this).text();
                              $(this).html('<input type="text" placeholder="Search ' + title + '" />');
                          });

                          // instantiate the table as a datatable, make its default pagelength at 100, allow an existing table to be retrieved
                          // and push the search boxes at the foot to the top of the table, below the header
                         var table = $('#contentTable').DataTable({
                              "pageLength": 100,
                              retrieve: true,
                              initComplete: function () {
                                  var r = $('#contentTable tfoot tr');
                                  r.find('th').each(function () {
                                      $(this).css('padding', 8);
                                  });
                                  $('#contentTable thead').append(r);
                                  $('#search_0').css('text-align', 'center');
                              },
                          });

                          // when the refresh button is clicked, clear the search parameters on the table and redraw the table.
                          $('#refreshButton').on('click', function (event) {
                              table
                                .search('')
                                .columns().search('')
                                .draw();
                          });


                          // Apply the search to the table
                          table.columns().every(function () {
                              var that = this;
                              $('input', this.footer()).on('keyup change', function () {
                                  if (that.search() !== this.value) {
                                      that
                                          .search(this.value)
                                          .draw();
                                  }
                              });
                          });

                      });
                  });
            });
        }
        </script>



    </body>
     
</html>